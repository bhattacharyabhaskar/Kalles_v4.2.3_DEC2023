{% layout none %}
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:video="http://www.google.com/schemas/sitemap-video/1.1">

  <!-- Checking collections: buy-silk-mark-certified-saree, suites-dresses -->

  {% assign target_collections = "buy-silk-mark-certified-saree,suites-dresses" | split: "," %}

  {% for collection in collections %}
    {% if target_collections contains collection.handle %}
      
      <!-- Processing collection: {{ collection.title }} -->
      
      {% for product in collection.products %}
        {% assign has_inventory = false %}
        
        <!-- Check if any variant has inventory -->
        {% for variant in product.variants %}
          {% if variant.inventory_quantity > 0 %}
            {% assign has_inventory = true %}
            {% break %}
          {% endif %}
        {% endfor %}

        {% if has_inventory %}
          <url>
            <loc>{{ shop.url }}{{ product.url }}</loc>

            {% assign video_found = false %}
            {% assign video_url = "" %}
            {% assign thumbnail_url = "" %}
            
            {% for media in product.media %}
              {% if media.media_type == 'video' and video_found == false %}
                
                <!-- Find the MP4 video URL -->
                {% for source in media.sources %}
                  {% if source.format == "mp4" %}
                    {% assign video_url = source.url %}
                    {% break %}
                  {% endif %}
                {% endfor %}

                {% if video_url != "" %}
                  {% assign thumbnail_url = media.preview_image | image_url: width: 800 %}
                  
                  <video:video>
                    <video:thumbnail_loc>{{ thumbnail_url | prepend: "https:" }}</video:thumbnail_loc>
                    <video:title><![CDATA[{{ product.title }}]]></video:title>
                    <video:description><![CDATA[{{ product.description | strip_html | truncate: 200 }}]]></video:description>
                    <video:content_loc>{{ video_url | prepend: "https:" }}</video:content_loc>
                    <video:player_loc>{{ video_url | prepend: "https:" }}?autoplay=1</video:player_loc>
                    <video:publication_date>{{ product.created_at | date: "%Y-%m-%dT%H:%M:%SZ" }}</video:publication_date>
                  </video:video>

                  {% assign video_found = true %}
                {% endif %}
              {% endif %}
            {% endfor %}
          </url>
        {% else %}
          <!-- Skipping product: {{ product.title }} (Out of stock) -->
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endfor %}

</urlset>
