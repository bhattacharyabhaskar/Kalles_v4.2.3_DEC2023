{%- assign this_product = product -%}
{%- assign first_video = this_product.media | where: "media_type", "video" | first -%}
{%- assign mp4_source = first_video.sources | where: "format", "mp4" | first -%}

{%- if mp4_source and this_product.id -%}
  {%- assign unique_id = 'video_' | append: this_product.id -%}

  <div class="t4s-video-button-wrapper" style="margin: 10px 0; text-align: center;">
    <button id="watchVideoBtn-{{ unique_id }}" class="watch-video-btn" style="padding: 8px 16px; background-color: #b33c3c; color: white; font-size: 13px; font-weight: 700; border: none; border-radius: 4px;">
    {%- if this_product.type == 'Dress' -%}
      ▶️ WATCH & BUY
      {%- else -%}
      ▶️ SINGLE PIECE, WATCH NOW
    {%- endif -%}
    </button>
  </div>

  <div id="videoModal-{{ unique_id }}" class="video-modal" style="display:none; position:fixed; z-index:9999; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.8);">
    <div style="position:relative; width:90%; max-width:500px; margin:10% auto;">
      <span class="close-video" style="position:absolute; top:-30px; right:0; font-size:30px; color:white; cursor:pointer;">&times;</span>
      <video id="productVideo-{{ unique_id }}" controls style="width: 100%; height: auto;">
        <source src="{{ mp4_source.url }}" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var btn = document.getElementById("watchVideoBtn-{{ unique_id }}");
      var modal = document.getElementById("videoModal-{{ unique_id }}");
      var video = document.getElementById("productVideo-{{ unique_id }}");
      var close = modal.querySelector(".close-video");

      btn?.addEventListener("click", function () {
        modal.style.display = "block";
        video.play();
      });

      close?.addEventListener("click", function () {
        modal.style.display = "none";
        video.pause();
        video.currentTime = 0;
      });

      window.addEventListener("click", function (e) {
        if (e.target === modal) {
          modal.style.display = "none";
          video.pause();
          video.currentTime = 0;
        }
      });
    });
  </script>
{%- endif -%}
